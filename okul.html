<script type='text/javascript'>
	var okulW = 436;
	var okulH = 400;
	var partId = 40;
	var y = 0;
	var h = 400;
	var maskData;
	var okulRaw;
	var curButtons = [];

	function loadOkul() {
		var tOkulCanvas = document.getElementById("okulCanvas");
		var tOkulPanel = document.getElementById("okulPanel");
		var tClickOverlay = document.getElementById("clickOverlay");
		tOkulCanvas.width = okulW;
		tOkulCanvas.height = okulH;
		tOkulPanel.style.width = okulW;
		tOkulPanel.style.height = okulH;
		tClickOverlay.width = okulW;
		tClickOverlay.height = okulH;
		
		var okulCanvas = document.getElementById("okulCanvas").getContext("2d");
		var okulImage = new Image();
		okulImage.onload = function() {
			okulCanvas.drawImage(okulImage,0,0);
			okulRaw = okulCanvas.getImageData(0,0,okulW,okulH).data;
		}
		okulImage.src = "okulImage.png";

		var maskCanvas = document.createElement('canvas');
		maskCanvas.width  = okulW;
		maskCanvas.height = okulH;
		var maskImage = new Image();
		maskImage.onload = function() {
			maskCanvas.getContext("2d").drawImage(maskImage,0,0);
			maskData = maskCanvas.getContext("2d").getImageData(0,0,okulW,okulH).data;
		}
		maskImage.src = "okulMask.png";

		var globalDefault = document.getElementById('defColor');
		curButtons[40] = globalDefault;
		curButtons[80] = globalDefault;
		curButtons[120] = globalDefault;
		curButtons[160] = globalDefault;
		curButtons[200] = globalDefault;
	}
	
	/*PartColor:
	40 - Upper Body
	80 - Middle Body
	120 - Bottom Body
	160 - Ears
	200 - Wings
	240 - Nose
	*/ 
	function updateOkul(targetHue,multSat,addSat,multLum,addLum)
	{
		//var start = new Date().getTime();
		//TIMING

		var okulCanvas = document.getElementById("okulCanvas").getContext("2d");
		var okulData = okulCanvas.getImageData(0,y,okulW,h);
		var curColor;
		var tDataSize = okulData.data.length;
		var tRawShift = (y*okulW*4);
		for(var i = 0; i < tDataSize; i+=4)
		{	
			if(maskData[i+tRawShift] == partId && okulRaw[i+tRawShift+3] != 0)
			{
				curColor = tinycolor({ r: okulRaw[i+tRawShift], g: okulRaw[i+tRawShift+1], b: okulRaw[i+tRawShift+2], a: okulRaw[i+tRawShift+3] }).toHsl();
				curColor.h = targetHue;
				curColor.s = Math.min(curColor.s*multSat+addSat, 1.0);
				curColor.l = Math.min(curColor.l*multLum+addLum, 1.0);
				curColor = tinycolor(curColor).toRgb();
				okulData.data[i] = curColor.r;
				okulData.data[i+1] = curColor.g;
				okulData.data[i+2] = curColor.b;
			} 
		}
		okulCanvas.putImageData(okulData,0,y);
		
		//END TIMING
		//var end = new Date().getTime();
		//var time = end - start;
		//alert('Aeg: ' + time);
	}

	function changeButton(button)
	{
		curButtons[partId].className = "cB";
		button.className = "cB sB";
		curButtons[partId] = button;
	}

	function toggleColorMenu(newId, newY, newH)
	{
		curButtons[partId].className = "cB";
		curButtons[newId].className = "cB sB";
		y = newY;
		h = newH;
		var okulButtons = document.getElementById("colorMenu");
		if(okulButtons.className == "" && partId == newId)
		{
			okulButtons.className = "hide";
		}
		else
		{
			okulButtons.className = "";
		}
		partId = newId;
	}
</script>

<script type='text/javascript' src='tinycolor.js'></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>

<style>
	input.hueSlider {
    	width: 302px;
    	cursor: pointer;
		margin-left: 9px;
	}
	
	div.cB{
		position:relative;
		padding: 14%;
		padding: calc(16% - 3px);
		width: 0px;
		height: 0px;
		box-sizing: border-box;
		cursor: pointer;
		vertical-align:top;
        display:inline-block;
        margin: auto;
		border-style: solid;
		border-width: 2px;
		border-color: #000000;
		margin: 1px;
	}
	div.sB{
		border-color: #AAAAAA;
	}
	div.hide{
		visibility: hidden;
	}
</style>

<body onLoad="loadOkul()" id="root">
	<div id="okulPanel" style="position: relative;">
		<canvas id="okulCanvas" width="300" height="300" style="position: absolute;"></canvas>
		<img src="transp.png" id="clickOverlay" usemap="#okulMap" width="300" height="300" style="position: absolute;">
		<map name="okulMap">
			<area href="javascript:toggleColorMenu(40,76,107)" shape="poly" coords="57,182,366,167,319,92,84,81">
			<area href="javascript:toggleColorMenu(80,164,152)" shape="poly" coords="64,179,83,276,374,274,364,172">
			<area href="javascript:toggleColorMenu(120,268,111)" shape="poly" coords="77,273,121,338,200,374,307,348,356,312,367,261">
		</map>
		<div id="colorMenu" class="hide" style="position:absolute; left: 436px; width: 200px; font-size: 0px; text-align: center;">
			<div class="cB" id="defColor" onclick="changeButton(this); updateOkul(353, 2.5, 0.07, 0.94, 0.01);" style="background-color: #800020"></div>
			<div class="cB" onclick="changeButton(this); updateOkul(0, 1.1, 0.43, 1.19, 0.07);" style="background-color: #E30000"></div>
			<div class="cB" onclick="changeButton(this); updateOkul(229,0.98,0,1.19,0.07);" style="background-color: #3E38EB"></div>
			<div class="cB" onclick="changeButton(this); updateOkul(173,1.95,0.24,1.19,0.08);" style="background-color: #4dffff"></div>
			<div class="cB" onclick="changeButton(this); updateOkul();" style="background-color: #000"></div>
			<div class="cB" onclick="changeButton(this); updateOkul();" style="background-color: #000"></div>
			<div class="cB" onclick="changeButton(this); updateOkul();" style="background-color: #000"></div>
			<div class="cB" onclick="changeButton(this); updateOkul();" style="background-color: #000"></div>
			<div class="cB" onclick="changeButton(this); updateOkul();" style="background-color: #000"></div>
			<div class="cB" onclick="changeButton(this); updateOkul();" style="background-color: #000"></div>
			<div class="cB" onclick="changeButton(this); updateOkul();" style="background-color: #000"></div>
			<div class="cB" onclick="changeButton(this); updateOkul();" style="background-color: #000"></div>
		</div>
	</div>
	<input type="range" onchange="updateOkul(+this.value,document.getElementById('OSat').value*0.01,document.getElementById('OASat').value*0.01,document.getElementById('OLum').value*0.01, document.getElementById('OALum').value*0.01); document.getElementById('LHue').innerHTML = this.value;" id="OHue" class="hueSlider" min="0" max="360"><span id='LHue'></span><br>
	<input type="range" onchange="updateOkul(document.getElementById('OHue').value,this.value*0.01,document.getElementById('OASat').value*0.01,document.getElementById('OLum').value*0.01, document.getElementById('OALum').value*0.01); document.getElementById('LSat').innerHTML = this.value*0.01;" id="OSat" class="hueSlider" min="0" max="300"><span id='LSat'></span><br>
	<input type="range" onchange="updateOkul(document.getElementById('OHue').value,document.getElementById('OSat').value*0.01,this.value*0.01,document.getElementById('OLum').value*0.01, document.getElementById('OALum').value*0.01); document.getElementById('LASat').innerHTML = this.value*0.01;" id="OASat" class="hueSlider" min="-100" max="100"><span id='LASat'></span><br>
	<input type="range" onchange="updateOkul(document.getElementById('OHue').value,document.getElementById('OSat').value*0.01,document.getElementById('OASat').value*0.01,this.value*0.01, document.getElementById('OALum').value*0.01); document.getElementById('LLum').innerHTML = this.value*0.01;" id="OLum" class="hueSlider" min="0" max="200"><span id='LLum'></span><br>
	<input type="range" onchange="updateOkul(document.getElementById('OHue').value, document.getElementById('OSat').value*0.01,document.getElementById('OASat').value*0.01, document.getElementById('OLum').value*0.01, this.value*0.01); document.getElementById('LALum').innerHTML = this.value*0.01;" id="OALum" class="hueSlider" min="-50" max="50"><span id='LALum'></span><br>
	<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/ad/HueScale.svg/320px-HueScale.svg.png">
	<form>
		<input type="text" placeholder="Nimi"> <br>
		<input type="email" placeholder="Meiliaadress"> <br>
	</form>
</body>
